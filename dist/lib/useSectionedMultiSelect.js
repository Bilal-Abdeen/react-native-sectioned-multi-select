var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(exports,"__esModule",{value:true});exports.useSectionedMultiSelect=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var React=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _helpers=require("./helpers");var _useEnhancedReducer3=_interopRequireWildcard(require("./reducer/useEnhancedReducer"));var _itemsReducer=_interopRequireDefault(require("./reducer/itemsReducer"));var _sectionedMultiSelect=require("./sectioned-multi-select");var _components=require("./components");var _this=this,_jsxFileName="/Users/renrizzolo/Documents/websites/react-native-sectioned-multi-select/lib/useSectionedMultiSelect.js";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){(0,_defineProperty2.default)(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}var useSectionedMultiSelect=function useSectionedMultiSelect(props){var Icon=props.iconRenderer;var getTheme=function getTheme(){return{styles:_reactNative.StyleSheet.flatten([_sectionedMultiSelect.defaultStyles,props.styles]),colors:_reactNative.StyleSheet.flatten([_sectionedMultiSelect.defaultColors,props.colors])};};var _React$useState=React.useState(getTheme),_React$useState2=(0,_slicedToArray2.default)(_React$useState,1),theme=_React$useState2[0];var initialProps=_objectSpread(_objectSpread({},_sectionedMultiSelect.SMSDefaultProps),props);var getProps=React.useMemo(function(){return initialProps;},[initialProps]);var getStyles=function getStyles(key,props,stylesFromComponentProps){var colors=theme.colors;var propsObj=_objectSpread({colors:colors},props);console.log('passing',propsObj,'to',key);var styles=_sectionedMultiSelect.defaultStyles[key](propsObj);var custom=getProps.styles[key];var extra=stylesFromComponentProps&&stylesFromComponentProps[key];styles=custom?custom(styles,propsObj):styles;return extra?extra(styles,props):styles;};var components=React.useMemo(function(){var c=(0,_components.defaultComponents)({components:getProps.components,iconNames:getProps.iconNames,colors:theme.colors,styles:theme.styles,getStyles:getStyles,iconRenderer:getProps.iconRenderer});return c;},[props.components]);var middleware=[].concat((0,_toConsumableArray2.default)(getProps.debug?[_useEnhancedReducer3.loggerMiddleware]:[]),(0,_toConsumableArray2.default)(getProps.onSelectedItemsChange?[_useEnhancedReducer3.thunkMiddleware]:[]));var _useEnhancedReducer=(0,_useEnhancedReducer3.default)(_itemsReducer.default,props.initialSelectedItems,middleware),_useEnhancedReducer2=(0,_slicedToArray2.default)(_useEnhancedReducer,2),selectedItems=_useEnhancedReducer2[0],dispatch=_useEnhancedReducer2[1];console.log('SELECTED ITEMS',selectedItems);React.useEffect(function(){if(getProps.single){dispatch({type:'replace-items',items:selectedItems[0]?[selectedItems[0]]:[]});}},[getProps.single]);React.useEffect(function(){if(getProps.onSelectedItemObjectsChange&&getProps.items.length){console.log('items before find be fore broadcast..',getProps.items,props.items);_broadcastItemObjects();}},[selectedItems,getProps.items]);var onSelectedItemsChangeInternal=function onSelectedItemsChangeInternal(action){var onSelectedItemsChange=getProps.onSelectedItemsChange,onSelectedItemObjectsChange=getProps.onSelectedItemObjectsChange;dispatch(onSelectedItemsChange?onSelectedItemsChange(action):action);};var _React$useState3=React.useState(''),_React$useState4=(0,_slicedToArray2.default)(_React$useState3,2),searchTerm=_React$useState4[0],setSearchTerm=_React$useState4[1];var _React$useState5=React.useState(false),_React$useState6=(0,_slicedToArray2.default)(_React$useState5,2),selectIsVisible=_React$useState6[0],setSelectIsVisible=_React$useState6[1];var _React$useState7=React.useState([]),_React$useState8=(0,_slicedToArray2.default)(_React$useState7,2),highlightedChildren=_React$useState8[0],setHighlightedChildren=_React$useState8[1];var _filterItems=function _filterItems(searchTerm){var items=getProps.items,subKey=getProps.subKey,itemId=getProps.itemId,childItemId=getProps.childItemId,getChildren=getProps.getChildren,displayKey=getProps.displayKey,filterItems=getProps.filterItems;if(filterItems){return filterItems(searchTerm,items,getProps);}var filteredItems=[];var newFilteredItems=[];items&&items.forEach(function(item){var parts=searchTerm.replace(/[\^$\\.*+?()[\]{}|]/g,'\\$&').trim().split(' ');var regex=new RegExp("("+parts.join('|')+")",'i');if(regex.test((0,_helpers.getProp)(item,displayKey))){filteredItems.push(item);}if(getChildren(item)){var newItem=(0,_extends2.default)({},item);newItem[subKey]=[];getChildren(item).forEach(function(sub){if(regex.test((0,_helpers.getProp)(sub,displayKey))){newItem[subKey]=[].concat((0,_toConsumableArray2.default)(getChildren(newItem)),[sub]);newFilteredItems=(0,_helpers.rejectProp)(filteredItems,function(singleItem){return childItemId(item)!==childItemId(singleItem);});newFilteredItems.push(newItem);filteredItems=newFilteredItems;}});}});return filteredItems;};var _checkIsParent=function _checkIsParent(item){var getChildren=getProps.getChildren,items=getProps.items;console.log('items in _checkIs',items);if(getChildren(item)){return true;}if(items){for(var i=0;i<items.length;i++){if(items[i]===item){return true;}}}};var _removeItem=function _removeItem(item,origin){var itemId=getProps.itemId,childItemId=getProps.childItemId,parentsHighlightChildren=getProps.parentsHighlightChildren,onSelectedItemObjectsChange=getProps.onSelectedItemObjectsChange;var itemToRemove=React.useCallback(function(){return _checkIsParent(item);},[item])?itemId(item):childItemId(item);var newItems=(0,_helpers.rejectProp)(selectedItems,function(singleItem){return itemToRemove!==singleItem;});var dispatchParams={type:'remove',item:itemToRemove,origin:origin};parentsHighlightChildren&&_unHighlightChildren(itemToRemove);onSelectedItemsChangeInternal(dispatchParams);};var _removeAllItems=function _removeAllItems(origin){var dispatchParams={type:'remove-all',origin:origin};var onSelectedItemObjectsChange=getProps.onSelectedItemObjectsChange;onSelectedItemsChangeInternal(dispatchParams);setHighlightedChildren([]);};var _selectAllItems=function _selectAllItems(origin){var items=getProps.items,itemId=getProps.itemId,getChildren=getProps.getChildren,childItemId=getProps.childItemId,onSelectedItemObjectsChange=getProps.onSelectedItemObjectsChange,parentsToggleChildrenOnly=getProps.parentsToggleChildrenOnly,readOnlyHeadings=getProps.readOnlyHeadings;var newItems=[];items&&items.forEach(function(item){if(!readOnlyHeadings||!parentsToggleChildrenOnly){newItems.push(itemId(item));}Array.isArray(getChildren(item))&&getChildren(item).forEach(function(childItem){newItems.push(childItemId(childItem));});});var dispatchParams={type:'replace-items',items:newItems,origin:origin,count:newItems.length};onSelectedItemsChangeInternal(dispatchParams);};var _toggleSelect=function _toggleSelect(){var onToggleSelect=getProps.onToggleSelect;var isVisible=!selectIsVisible;onToggleSelect&&onToggleSelect(isVisible);setSelectIsVisible(isVisible);};var _closeSelect=function _closeSelect(){var onToggleSelect=getProps.onToggleSelect;setSelectIsVisible(false);setSearchTerm('');onToggleSelect&&onToggleSelect(false);};var _submitSelection=function _submitSelection(){var onConfirm=getProps.onConfirm;_toggleSelect();setSearchTerm('');onConfirm&&onConfirm(selectedItems,dispatch);};var _cancelSelection=function _cancelSelection(){var onCancel=getProps.onCancel;_toggleSelect();setSearchTerm('');onCancel&&onCancel(selectedItems,dispatch);};var _itemSelected=function _itemSelected(item){return selectedItems.includes(item);};var _toggleChildren=function _toggleChildren(item,includeParent,isSelected){var onSelectedItemObjectsChange=getProps.onSelectedItemObjectsChange,itemId=getProps.itemId;var parentItem=itemId(item);var selected=_itemSelected(parentItem)||isSelected;var childItems=_getChildIdsArray(parentItem);var removedDuplicates=(0,_helpers.removeDuplicates)(childItems,selectedItems);var dispatchParams;if(selected){var itemsToDispatch=[].concat((0,_toConsumableArray2.default)(childItems),(0,_toConsumableArray2.default)(includeParent?[parentItem]:[]));dispatchParams={type:'remove-items',items:itemsToDispatch};}else{var _itemsToDispatch=[].concat((0,_toConsumableArray2.default)(removedDuplicates),(0,_toConsumableArray2.default)(includeParent?[parentItem]:[]));dispatchParams={type:'add-items',items:_itemsToDispatch,count:_itemsToDispatch.length};}onSelectedItemsChangeInternal(dispatchParams);};var _toggleItem=function _toggleItem(item,origin){var single=getProps.single,itemId=getProps.itemId,childItemId=getProps.childItemId,parentsToggleChildren=getProps.parentsToggleChildren,parentsHighlightChildren=getProps.parentsHighlightChildren,onSelectedItemObjectsChange=getProps.onSelectedItemObjectsChange,singleShouldSubmit=getProps.singleShouldSubmit;console.group('_toggleItem');var isParent=_checkIsParent(item);var itemToToggle=isParent?itemId(item):childItemId(item);var dispatchParams;var selected=_itemSelected(itemToToggle);dispatchParams=selected?{type:'remove',item:itemToToggle,origin:origin}:{type:'add',item:itemToToggle,origin:origin,count:1};if(single){dispatchParams=selected?{type:'remove-all',origin:origin}:{type:'add-single',item:itemToToggle,origin:origin,count:1};onSelectedItemsChangeInternal(dispatchParams);singleShouldSubmit&&_submitSelection();console.groupEnd();return;}if(isParent){if(parentsToggleChildren){_toggleChildren(item,true);return;}else if(parentsHighlightChildren){selected?_unHighlightChildren(itemToToggle):_highlightChildren(itemToToggle);}}console.log('toggle end dispatch params',dispatchParams);console.groupEnd();onSelectedItemsChangeInternal(dispatchParams);};var _removeParent=function _removeParent(item){var parent=findParent(item);console.log('parent to remove',parent);parent&&_removeItem(parent);};var _findItem=function _findItem(id){var items=getProps.items;console.log('find on',items);return find(id,items);};function find(id,items,isChild){if(!items){return{};}var getChildren=getProps.getChildren,itemId=getProps.itemId,childItemId=getProps.childItemId;var getFn=isChild?childItemId:itemId;var i=0;var found;for(;i<items.length;i+=1){if(getFn(items[i])===id){return items[i];}else if(Array.isArray(getChildren(items[i]))){found=find(id,getChildren(items[i]),true);if(found){return found;}}}}function findParent(item){var items=getProps.items,itemId=getProps.itemId,childItemId=getProps.childItemId,getChildren=getProps.getChildren;if(!items){return{};}var id=childItemId(item);if(!id){return{};}var i=0;var found;for(;i<items.length;i+=1){if(Array.isArray(getChildren(items[i]))){found=find(id,getChildren(items[i]),true);if(found){return items[i];}}}}function reduceSelected(array,toSplice){var childItemId=getProps.childItemId;array.reduce(function(prev,curr){toSplice.includes(childItemId(curr))&&toSplice.splice(toSplice.findIndex(function(el){return el===childItemId(curr);}),1);},{});return toSplice;}var _highlightChildren=function _highlightChildren(id){var items=getProps.items,itemId=getProps.itemId,childItemId=getProps.childItemId,getChildren=getProps.getChildren;var highlighted=(0,_toConsumableArray2.default)(highlightedChildren);if(!items)return;var i=0;for(;i<items.length;i+=1){if(itemId(items[i])===id&&Array.isArray(getChildren(items[i]))){getChildren(items[i]).forEach(function(sub){!highlighted.includes(childItemId(sub))&&highlighted.push(childItemId(sub));});}}console.log('highlighting children of',id,highlighted);setHighlightedChildren(highlighted);};var _unHighlightChildren=function _unHighlightChildren(id){var items=getProps.items,itemId=getProps.itemId,getChildren=getProps.getChildren;var highlighted=(0,_toConsumableArray2.default)(highlightedChildren);var array=items.filter(function(item){return itemId(item)===id;});if(!array['0']){return;}if(array['0']&&!getChildren(array['0'])){return;}var newHighlighted=reduceSelected(getChildren(array['0']),highlighted);setHighlightedChildren(newHighlighted);};var _selectChildren=function _selectChildren(id){var items=getProps.items,itemId=getProps.itemId,childItemId=getProps.childItemId,getChildren=getProps.getChildren;if(!items)return;var i=0;var selected=[];for(;i<items.length;i+=1){if(itemId(items[i])===id&&Array.isArray(getChildren(items[i]))){getChildren(items[i]).forEach(function(sub){!selectedItems.includes(childItemId(sub))&&selected.push(childItemId(sub));});}}_highlightChildren(id);return selected;};var _getChildIdsArray=function _getChildIdsArray(id){var items=getProps.items,childItemId=getProps.childItemId,getChildren=getProps.getChildren,itemId=getProps.itemId;var newItems=[];var item=items.filter(function(item){return itemId(item)===id;});if(!item[0]){return newItems;}var children=getChildren(item[0]);if(!children){return newItems;}for(var i=0;i<children.length;i++){newItems.push(childItemId(children[i]));}return newItems;};var _rejectChildren=function _rejectChildren(id){var items=getProps.items,itemId=getProps.itemId,childItemId=getProps.childItemId,getChildren=getProps.getChildren;var arrayOfChildren=items.filter(function(item){return itemId(item)===id;});var selected=(0,_toConsumableArray2.default)(selectedItems);if(!arrayOfChildren['0']){return;}if(arrayOfChildren['0']&&!getChildren(arrayOfChildren['0'])){return;}var newSelected=reduceSelected(getChildren(arrayOfChildren['0']),selected);_unHighlightChildren(id);return newSelected;};var _getSearchTerm=function _getSearchTerm(){return searchTerm;};var _broadcastItemObjects=function _broadcastItemObjects(){var onSelectedItemObjectsChange=getProps.onSelectedItemObjectsChange;if(onSelectedItemObjectsChange){var fullItems=[];selectedItems.forEach(function(singleSelectedItem){var item=_findItem(singleSelectedItem);fullItems.push(item);});console.log('selectedItemObjects',selectedItems,fullItems);onSelectedItemObjectsChange(fullItems);}};var getItemId=function getItemId(item){var itemId=getProps.itemId,childItemId=getProps.childItemId;return _checkIsParent(item)?itemId(item):childItemId(item);};var getModalProps=function getModalProps(){var modalProps=getProps.modalProps;return _objectSpread({transparent:true,visible:selectIsVisible,onRequestClose:_closeSelect},modalProps);};var getFlatListItemProps=function getFlatListItemProps(){var getChildren=getProps.getChildren,itemId=getProps.itemId,childItemId=getProps.childItemId,iconKey=getProps.iconKey,displayKey=getProps.displayKey;var styles=theme.styles,colors=theme.colors;return{iconKey:iconKey,displayKey:displayKey,selectedItems:selectedItems,highlightedChildren:highlightedChildren,setHighlightedChildren:setHighlightedChildren,getChildren:getChildren,itemId:itemId,childItemId:childItemId,stylesFromContext:styles,colors:colors};};var _renderItemFlatList=function _renderItemFlatList(_ref){var item=_ref.item;var props=getFlatListItemProps();return React.createElement(components.RowItem,(0,_extends2.default)({item:item},props,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:633,columnNumber:12}}));};var getStateAndHelpers=function getStateAndHelpers(){var styles=theme.styles,colors=theme.colors;var items=getProps.items;var renderItems=searchTerm?_filterItems(searchTerm.trim()):items;return _objectSpread(_objectSpread({getStyles:getStyles,_toggleSelect:_toggleSelect,_toggleChildren:_toggleChildren,_closeSelect:_closeSelect,_submitSelection:_submitSelection,_cancelSelection:_cancelSelection,_getSearchTerm:_getSearchTerm,_itemSelected:_itemSelected,_removeAllItems:_removeAllItems,_removeItem:_removeItem,_toggleItem:_toggleItem,_selectAllItems:_selectAllItems,_findItem:_findItem,_filterItems:_filterItems,_checkIsParent:_checkIsParent,getModalProps:getModalProps,setSearchTerm:setSearchTerm,_renderItemFlatList:_renderItemFlatList,Icon:Icon},getProps),{},{components:components,selectedItems:selectedItems,searchTerm:searchTerm,selectIsVisible:selectIsVisible,styles:styles,colors:colors,renderItems:renderItems});};return getStateAndHelpers();};exports.useSectionedMultiSelect=useSectionedMultiSelect;